<div class="card">
  <div class="card-header">
    <h2 class="card-title">
      <i class="fa fa-map-marker"></i> Progression de la livraison
    </h2>
  </div>


  <!-- üîç Filtres -->
  <div class="card-body">
    <div class="row mb-3">
      <!-- üìÖ Date de d√©but -->
      <div class="col-md-3 mb-3">
        <label for="dateDebut" class="form-label fw-bold">Date de d√©but</label>
        <input type="date" id="dateDebut" class="form-control" [(ngModel)]="dateDebut" (change)="filtrerParDate()" />
      </div>

      <!-- üìÖ Date de fin -->
      <div class="col-md-3 mb-3">
        <label for="dateFin" class="form-label fw-bold">Date de fin</label>
        <input type="date" id="dateFin" class="form-control" [(ngModel)]="dateFin" (change)="filtrerParDate()" />
      </div>

      <!-- üë§ Client -->
      <div class="col-md-3 mb-3">
        <label for="client" class="form-label fw-bold">Client</label>
        <input type="text" id="client" class="form-control" placeholder="Rechercher un client..."
          [(ngModel)]="filtreClient" (input)="filtrerParDate()" />
      </div>

      <!-- üè¢ Site -->
      <div class="col-md-3 mb-3">
        <label for="site" class="form-label fw-bold">Site</label>
        <select id="site" class="form-control" [(ngModel)]="filtreSite" (change)="filtrerParDate()">
          <option value="">S√©lectionner un site...</option>
          <option *ngFor="let site of siteOptions" [value]="site">{{ site }}</option>
        </select>
      </div>
    </div>
    <!-- üü¶ Statut -->
    <div class="col-md-3 mb-3">
      <label for="statut" class="form-label fw-bold">Statut</label>
      <select id="statut" class="form-control" [(ngModel)]="filtreStatut" (change)="filtrerParDate()">
        <option value="">Tous les statuts...</option>
        <option *ngFor="let st of statutOptions" [value]="st">{{ st }}</option>
      </select>
    </div>


    <!-- üîÅ Bouton de r√©initialisation -->
    <div class="row">
      <div class="col-md-3">
        <button class="btn btn-secondary w-100" (click)="resetFiltre()">
          R√©initialiser
        </button>
      </div>
    </div>
  </div>


  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Date Cr√©ation</th>
            <th>Date Liv. Pr√©vue</th>
            <th>Num√©ro d'Ordre</th>
            <th>Client</th>
            <th>Source</th>
            <th>Destination</th>
            <th>Site</th>
            <th>Temp√©rature</th>
            <th>Commentaires</th>
            <th>Statut</th>
            <th>VOYCLE</th>
            <th>Chauffeur</th>
            <th>Camion</th>
            <th>Date Voyage</th>
            <th>√âv√©nements</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let ordre of ordresFiltres">
            <tr *ngIf="ordre.statut !== 'NON_CONFIRME'"
              [ngClass]="{ 'row-non-planifie': ordre.statut === 'NON_PLANIFIE' }">
              <td>{{ ordre.dateSaisie | date:'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ ordre.livraisonDate | date:'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ ordre.orderNumber }}</td>
              <td>{{ ordre.client }}</td>
              <td>
                <strong>Nom:</strong> {{ ordre.chargementNom }}<br>
                <strong>Adresse 1:</strong> {{ ordre.chargementAdr1 }}<br>
                <strong>Ville:</strong> {{ ordre.chargementVille }}<br>
              </td>
              <td>
                <strong>Nom:</strong> {{ ordre.livraisonNom }}<br>
                <strong>Adresse 1:</strong> {{ ordre.livraisonAdr1 }}<br>
                <strong>Ville:</strong> {{ ordre.livraisonVille }}<br>
              </td>
              <td>{{ ordre.siteclient }}</td>
              <td>{{ ordre.codeArticle }}</td>
              <td>
                <span *ngFor="let c of ordre.commentaires" class="badge bg-info me-1">
                  {{ c }}
                </span>
              </td>
              <td [ngClass]="{ 'statut-non-planifie': ordre.statut === 'NON_PLANIFIE' }">
                <span class="status-badge" [ngClass]="{
                      'status-completed': getTimelineClass(statutMap[ordre.statut] || 0, ordre.events, ordre.statut) === 'completed',
                      'status-pending': getTimelineClass(statutMap[ordre.statut] || 0, ordre.events, ordre.statut) === 'pending',
                      'status-inactive': getTimelineClass(statutMap[ordre.statut] || 0, ordre.events, ordre.statut) === 'inactive'
                    }">
                  {{ ordre.statut }}
                </span>
              </td>

              <td>{{ ordre.voycle }}</td>
              <td>{{ ordre.chauffeur }} <br>{{ ordre.telchauffeur }}</td>
              <td>{{ ordre.camion }}</td>
              <td>{{ ordre.datevoy }}</td>
              <td>
                <div class="delivery-timeline">

                  <div class="timeline-step" [ngClass]="getTimelineClass(0, ordre.events, ordre.statut)">
                    <div class="timeline-icon">üè¢</div>
                    <div class="timeline-label">D√©part</div>
                    <div *ngIf="eventCount!=0" class="timeline-time"><i class="fa fa-clock"></i> {{ ordre.events[0] }}
                    </div>
                  </div>
                  <div class="timeline-step" [ngClass]="getTimelineClass(1, ordre.events, ordre.statut)">
                    <div class="timeline-icon"> <img src="assets\chargement.png"> </div>
                    <div class="timeline-label">Chargement</div>
                    <div *ngIf="eventCount!=0" class="timeline-time"><i class="fa fa-clock"></i> {{ ordre.events[1] }}
                    </div>
                  </div>
                  <div class="timeline-step" [ngClass]="getTimelineClass(2, ordre.events, ordre.statut)">
                    <div class="timeline-icon">üöö</div>
                    <div class="timeline-label">Charg√©</div>
                    <div *ngIf="eventCount!=0" class="timeline-time"><i class="fa fa-clock"></i> {{ ordre.events[2] }}
                    </div>
                  </div>
                  <div class="timeline-step" [ngClass]="getTimelineClass(3, ordre.events, ordre.statut)">
                    <div class="timeline-icon">üöõ</div>
                    <div class="timeline-label">Livraison</div>
                    <div *ngIf="eventCount!=0" class="timeline-time"><i class="fa fa-clock"></i> {{ ordre.events[3] }}
                    </div>
                  </div>
                  <div class="timeline-step" [ngClass]="getTimelineClass(4, ordre.events, ordre.statut)">
                    <div class="timeline-icon">üìã</div>
                    <div class="timeline-label">Livr√©</div>
                    <div *ngIf="eventCount!=0" class="timeline-time"><i class="fa fa-clock"></i>{{ ordre.events[4] }}
                    </div>
                  </div>
                  <div class="timeline-step" [ngClass]="getTimelineClass(5, ordre.events, ordre.statut)">
                    <div class="timeline-icon">üèÅ</div>
                    <div class="timeline-label">Fin</div>
                    <div *ngIf="eventCount!=0" class="timeline-time"><i class="fa fa-clock"></i> {{ ordre.events[5] }}
                    </div>
                  </div>

                </div>
              </td>
              <td>
                <div class="btn-group" role="group" aria-label="Actions">
                  <button class="btn btn-outline-info btn-sm" (click)="detail(ordre)" routerLink="/material/ordredetail"
                    title="Consulter">
                    <i class="fa fa-eye"></i>
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" title="Carte">
                    <i class="fa fa-map"></i>
                  </button>
                  <button class="btn btn-outline-warning btn-sm" (click)="openModal(); getEmail(ordre.client)"
                    title="Envoyer un email">
                    <i class="fa fa-envelope"></i>
                  </button>
                  <button class="btn btn-outline-primary btn-sm" (click)="sendSms(ordre.client, ordre)"
                    title="Envoyer un SMS">
                    <i class="fa-solid fa-comment-sms"></i>
                  </button>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal for sending email -->
<div class="modal" [ngClass]="{'show': isModalOpen}" (click)="closeModal($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <span class="close" (click)="closeModal()">√ó</span>
    <h2>Envoyer un Email</h2>
    <form (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label for="to">√Ä</label>
        <input type="email" id="to" name="to" [(ngModel)]="email.to" required class="form-control" />
      </div>
      <div class="form-group">
        <label for="subject">Objet</label>
        <input type="text" id="subject" name="subject" [(ngModel)]="email.subject" required class="form-control" />
      </div>
      <div class="form-group">
        <label for="body">Message</label>
        <textarea id="body" name="body" [(ngModel)]="email.body" required class="form-control" rows="6"></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Envoyer</button>
    </form>
  </div>
</div>